################################################################################
# Praat Script (Fixed Paths, Table Handling)
# - Reads .wav files from a fixed folder
# - Processes: onset detection, trimming, F0 extraction
# - Selects median F0 file and saves it
# - Creates a pitch-shifted version (-400 cents)
################################################################################
# An empty table is created to ensure Remove is available
Create Table with column names: "placeholder", 10, { "placeholder1" }
clearinfo
select all
Remove

# Set fixed input/output folder and subject ID
folder$ = "C:\\Users\\timdr\\OneDrive\\Uni_Oldenburg\\4_Semester\\Master_Thesis\\Analysis_Experiment\\psam_private\\praat\\test2"
subjectID$ = "999"

# Get list of all .wav files in the folder
Create Strings as file list: "fileList", folder$ + "/*.wav"
numberOfFiles = Get number of strings

# Create table with two columns: F0 values and filenames
Create Table with column names: "F0_Table", numberOfFiles, "f0_tab_normal f0_tab_pitched filename_tab"

rowIndex = 1

# numberOfFiles = 1

for i from 1 to numberOfFiles
    # Load raw file
    select Strings fileList
    file_raw$ = Get string: i 
    fullPath_raw$ = folder$ + "\\" + file_raw$ 

    Read from file: fullPath_raw$
    soundName$ = selected$("Sound")
    soundName_raw$ = selected$("Sound")+ "_raw"
    Rename: soundName_raw$ 

    # Detect onset and offset
    To TextGrid (silences): 100, 0, -15, 0.1, 0.1, "silent", "sounding"
    
    select TextGrid 'soundName_raw$'
    onset = Get starting point: 1, 2
    offset = Get end point: 1, 2
    duration = offset - onset
    
    select Sound 'soundName_raw$'
        
    # Extract and rename trimmed sound safely
    Extract part: onset, offset, "rectangular", 1, "no"
    soundName_trimmed_raw$ = soundName$ + "_trimmed_raw"   
    Rename: soundName_trimmed_raw$        

    # Pitch shift 0 ST
    selectObject: "Sound " + soundName_trimmed_raw$
    To Manipulation: 0.01, 75, 600
    selectObject: "Manipulation " + soundName_trimmed_raw$
    manipulationName_zeroST$ = soundName$ + "_zeroST" 
    Rename: manipulationName_zeroST$ 
    Extract pitch tier
    selectObject: "PitchTier " + manipulationName_zeroST$
    Shift frequencies: 0, 80, 0, "semitones"

    selectObject: "Manipulation " + manipulationName_zeroST$
    plusObject: "PitchTier " + manipulationName_zeroST$
    Replace pitch tier
    selectObject: "Manipulation " + manipulationName_zeroST$
    Get resynthesis (LPC)

    select Sound 'manipulationName_zeroST$'
        
    # Extract and rename trimmed sound safely
    Extract part: 0, 0.08, "rectangular", 1, "no"
    soundName_export_zeroST$ = "export_" + soundName$ + "_zeroST"
    Rename: soundName_export_zeroST$

    # Select and analyze F0
    selectObject: "Sound " + soundName_export_zeroST$
    To Pitch: 0.0, 75, 600
    f0_normal = Get mean: 0, 0, "Hertz"

    # Add F0 and filename to the table
    select Table F0_Table
    Set numeric value... rowIndex f0_tab_normal f0_normal
    select Table F0_Table
    Set string value... rowIndex filename_tab 'soundName$'

    normalProbePath$ = "C:\\Users\\timdr\\OneDrive\\Uni_Oldenburg\\4_Semester\\Master_Thesis\\Analysis_Experiment\\psam_private\\praat\\test3"
    select Sound 'soundName_export_zeroST$'
    Save as WAV file: normalProbePath$ + "\\" + soundName$ + "_normal.wav"

    # Pitch shift -2 ST
    selectObject: "Sound " + soundName_trimmed_raw$
    To Manipulation: 0.01, 75, 600
    selectObject: "Manipulation " + soundName_trimmed_raw$
    manipulationName_twoST$ = soundName$ + "_twoST" 
    Rename: manipulationName_twoST$ 
    Extract pitch tier
    selectObject: "PitchTier " + manipulationName_twoST$
    Shift frequencies: 0, 80, -2, "semitones"

    selectObject: "Manipulation " + manipulationName_twoST$
    plusObject: "PitchTier " + manipulationName_twoST$
    Replace pitch tier
    selectObject: "Manipulation " + manipulationName_twoST$
    Get resynthesis (LPC)

    select Sound 'manipulationName_twoST$'
        
    # Extract and rename trimmed sound safely
    Extract part: 0, 0.08, "rectangular", 1, "no"
    soundName_export_twoST$ = "export_" + soundName$ + "_twoST"
    Rename: soundName_export_twoST$

    # Select and analyze F0
    select Sound 'soundName_export_twoST$'
    To Pitch: 0.0, 75, 600
    f0_pitched = Get mean: 0, 0, "Hertz"

    # Add F0 and filename to the table
    select Table F0_Table
    Set numeric value... rowIndex f0_tab_pitched f0_pitched
    select Table F0_Table
    Set string value... rowIndex filename_tab 'soundName$'

    rowIndex = rowIndex + 1


    

    # Save pitch-shifted version
    pitchProbePath$ = "C:\\Users\\timdr\\OneDrive\\Uni_Oldenburg\\4_Semester\\Master_Thesis\\Analysis_Experiment\\psam_private\\praat\\test4"
    select Sound 'soundName_export_twoST$'
    Save as WAV file: pitchProbePath$ + "\\" + soundName$ + "_pitched.wav"

    
    
endfor

selectObject: "Table F0_Table"
Save as comma-separated file: pitchProbePath$ + "\\" + "f0_table.csv"

writeInfoLine: "Processing complete! Files saved!"






















